{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.buildDpopFetch = exports.buildBearerFetch = void 0;\n\nconst solid_client_authn_core_1 = require(\"@inrupt/solid-client-authn-core\");\n\nfunction buildBearerFetch(authToken) {\n  return (init, options) => {\n    return fetch(init, { ...options,\n      credentials: \"include\",\n      headers: { ...(options === null || options === void 0 ? void 0 : options.headers),\n        Authorization: `Bearer ${authToken}`\n      }\n    });\n  };\n}\n\nexports.buildBearerFetch = buildBearerFetch;\n\nasync function buildDpopFetchOptions(targetUrl, authToken, dpopKey, defaultOptions) {\n  var _a;\n\n  return { ...defaultOptions,\n    headers: { ...(defaultOptions === null || defaultOptions === void 0 ? void 0 : defaultOptions.headers),\n      Authorization: `DPoP ${authToken}`,\n      DPoP: await solid_client_authn_core_1.createDpopHeader(targetUrl, (_a = defaultOptions === null || defaultOptions === void 0 ? void 0 : defaultOptions.method) !== null && _a !== void 0 ? _a : \"get\", dpopKey)\n    },\n    credentials: \"include\"\n  };\n}\n\nfunction isExpectedAuthError(statusCode) {\n  return [401, 403].includes(statusCode);\n}\n\nasync function buildDpopFetch(authToken, dpopKey) {\n  return async (url, options) => {\n    const response = await fetch(url, await buildDpopFetchOptions(url.toString(), authToken, dpopKey, options));\n    const failedButNotExpectedAuthError = !response.ok && !isExpectedAuthError(response.status);\n    const hasBeenRedirected = response.url !== url;\n\n    if (response.ok || failedButNotExpectedAuthError || !hasBeenRedirected) {\n      return response;\n    }\n\n    return fetch(response.url, await buildDpopFetchOptions(response.url, authToken, dpopKey, options));\n  };\n}\n\nexports.buildDpopFetch = buildDpopFetch;","map":{"version":3,"sources":["../../src/authenticatedFetch/fetchFactory.ts"],"names":[],"mappings":";;;;;;;AAqBA,MAAA,yBAAA,GAAA,OAAA,CAAA,iCAAA,CAAA;;AASA,SAAgB,gBAAhB,CAAiC,SAAjC,EAAkD;AAChD,SAAO,CAAC,IAAD,EAAO,OAAP,KAAqC;AAC1C,WAAO,KAAK,CAAC,IAAD,EAAO,EACjB,GAAG,OADc;AAEjB,MAAA,WAAW,EAAE,SAFI;AAGjB,MAAA,OAAO,EAAE,EACP,IAAG,OAAO,KAAA,IAAP,IAAA,OAAO,KAAA,KAAA,CAAP,GAAO,KAAA,CAAP,GAAA,OAAO,CAAE,OAAZ,CADO;AAEP,QAAA,aAAa,EAAE,UAAU,SAAS;AAF3B;AAHQ,KAAP,CAAZ;AAQD,GATD;AAUD;;AAXD,OAAA,CAAA,gBAAA,GAAA,gBAAA;;AAaA,eAAe,qBAAf,CACE,SADF,EAEE,SAFF,EAGE,OAHF,EAIE,cAJF,EAI8B;;;AAE5B,SAAO,EACL,GAAG,cADE;AAEL,IAAA,OAAO,EAAE,EACP,IAAG,cAAc,KAAA,IAAd,IAAA,cAAc,KAAA,KAAA,CAAd,GAAc,KAAA,CAAd,GAAA,cAAc,CAAE,OAAnB,CADO;AAEP,MAAA,aAAa,EAAE,QAAQ,SAAS,EAFzB;AAGP,MAAA,IAAI,EAAE,MAAM,yBAAA,CAAA,gBAAA,CACV,SADU,EAEV,CAAA,EAAA,GAAA,cAAc,KAAA,IAAd,IAAA,cAAc,KAAA,KAAA,CAAd,GAAc,KAAA,CAAd,GAAA,cAAc,CAAE,MAAhB,MAAsB,IAAtB,IAAsB,EAAA,KAAA,KAAA,CAAtB,GAAsB,EAAtB,GAA0B,KAFhB,EAGV,OAHU;AAHL,KAFJ;AAWL,IAAA,WAAW,EAAE;AAXR,GAAP;AAaD;;AAED,SAAS,mBAAT,CAA6B,UAA7B,EAA+C;AAI7C,SAAO,CAAC,GAAD,EAAM,GAAN,EAAW,QAAX,CAAoB,UAApB,CAAP;AACD;;AASM,eAAe,cAAf,CACL,SADK,EAEL,OAFK,EAEW;AAEhB,SAAO,OAAO,GAAP,EAAY,OAAZ,KAA0C;AAC/C,UAAM,QAAQ,GAAG,MAAM,KAAK,CAC1B,GAD0B,EAE1B,MAAM,qBAAqB,CAAC,GAAG,CAAC,QAAJ,EAAD,EAAiB,SAAjB,EAA4B,OAA5B,EAAqC,OAArC,CAFD,CAA5B;AAIA,UAAM,6BAA6B,GACjC,CAAC,QAAQ,CAAC,EAAV,IAAgB,CAAC,mBAAmB,CAAC,QAAQ,CAAC,MAAV,CADtC;AAEA,UAAM,iBAAiB,GAAG,QAAQ,CAAC,GAAT,KAAiB,GAA3C;;AACA,QAAI,QAAQ,CAAC,EAAT,IAAe,6BAAf,IAAgD,CAAC,iBAArD,EAAwE;AAGtE,aAAO,QAAP;AACD;;AAGD,WAAO,KAAK,CACV,QAAQ,CAAC,GADC,EAEV,MAAM,qBAAqB,CAAC,QAAQ,CAAC,GAAV,EAAe,SAAf,EAA0B,OAA1B,EAAmC,OAAnC,CAFjB,CAAZ;AAID,GAnBD;AAoBD;;AAxBD,OAAA,CAAA,cAAA,GAAA,cAAA","sourceRoot":"","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nexports.buildDpopFetch = exports.buildBearerFetch = void 0;\nconst solid_client_authn_core_1 = require(\"@inrupt/solid-client-authn-core\");\nfunction buildBearerFetch(authToken) {\n    return (init, options) => {\n        return fetch(init, {\n            ...options,\n            credentials: \"include\",\n            headers: {\n                ...options === null || options === void 0 ? void 0 : options.headers,\n                Authorization: `Bearer ${authToken}`,\n            },\n        });\n    };\n}\nexports.buildBearerFetch = buildBearerFetch;\nasync function buildDpopFetchOptions(targetUrl, authToken, dpopKey, defaultOptions) {\n    var _a;\n    return {\n        ...defaultOptions,\n        headers: {\n            ...defaultOptions === null || defaultOptions === void 0 ? void 0 : defaultOptions.headers,\n            Authorization: `DPoP ${authToken}`,\n            DPoP: await solid_client_authn_core_1.createDpopHeader(targetUrl, (_a = defaultOptions === null || defaultOptions === void 0 ? void 0 : defaultOptions.method) !== null && _a !== void 0 ? _a : \"get\", dpopKey),\n        },\n        credentials: \"include\",\n    };\n}\nfunction isExpectedAuthError(statusCode) {\n    return [401, 403].includes(statusCode);\n}\nasync function buildDpopFetch(authToken, dpopKey) {\n    return async (url, options) => {\n        const response = await fetch(url, await buildDpopFetchOptions(url.toString(), authToken, dpopKey, options));\n        const failedButNotExpectedAuthError = !response.ok && !isExpectedAuthError(response.status);\n        const hasBeenRedirected = response.url !== url;\n        if (response.ok || failedButNotExpectedAuthError || !hasBeenRedirected) {\n            return response;\n        }\n        return fetch(response.url, await buildDpopFetchOptions(response.url, authToken, dpopKey, options));\n    };\n}\nexports.buildDpopFetch = buildDpopFetch;\n//# sourceMappingURL=fetchFactory.js.map"]},"metadata":{},"sourceType":"script"}